name: Test Installation Script

on:
  push:
    paths:
      - 'install.sh'
      - '.github/workflows/test-install.yml'
  workflow_dispatch:

jobs:
  # ========================
  # Test on Ubuntu
  # ========================
  test-ubuntu:
    name: Ubuntu ${{ matrix.ubuntu-version }}
    runs-on: ubuntu-${{ matrix.ubuntu-version }}
    strategy:
      fail-fast: false
      matrix:
        ubuntu-version: ['22.04', '24.04']
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ§¹ Clean & ğŸš€ Install & âœ… Verify
        run: |
          # Clean existing installations
          sudo rm -rf /usr/local/go /opt/hostedtoolcache/go || true
          
          # Check initial state
          echo "=== Initial State ==="
          echo "Go: $(go version 2>&1 || echo 'Not installed')"
          echo "Python: $(python3 --version 2>&1 || echo 'Not installed')"
          echo "FFmpeg: $(ffmpeg -version 2>&1 | head -n1 || echo 'Not installed')"
          echo "yt-dlp: $(yt-dlp --version 2>&1 || echo 'Not installed')"
          
          # Run installation
          echo -e "\n=== Running Installation ==="
          chmod +x install.sh
          ./install.sh
          
          # Refresh environment
          export PATH="/usr/local/go/bin:$HOME/.local/bin:$PATH"
          echo "/usr/local/go/bin" >> $GITHUB_PATH
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          
          # Verify installations
          echo -e "\n=== Verification ==="
          go version && echo "âœ“ Go OK" || exit 1
          ffmpeg -version | head -n1 && echo "âœ“ FFmpeg OK" || exit 1
          yt-dlp --version && echo "âœ“ yt-dlp OK" || exit 1
          python3 --version && echo "âœ“ Python OK" || exit 1
          
          # Check ntgcalls
          ls -lah ntgcalls/ *.so 2>/dev/null && echo "âœ“ ntgcalls OK" || echo "âš  ntgcalls files not found"
          
          # Build test
          go mod download && go mod verify
          CGO_ENABLED=1 go build ./cmd/app && echo "âœ“ Build successful"
        env:
          DEBIAN_FRONTEND: noninteractive

  # ========================
  # Test on macOS
  # ========================
  test-macos:
    name: macOS ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: ['macos-14', 'macos-15']
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ§¹ Clean & ğŸš€ Install & âœ… Verify
        run: |
          # Clean
          sudo rm -rf /usr/local/go ~/go || true
          
          # Initial state
          echo "=== Initial State ==="
          echo "macOS: $(sw_vers -productVersion)"
          echo "Arch: $(uname -m)"
          echo "Go: $(go version 2>&1 || echo 'Not installed')"
          echo "FFmpeg: $(ffmpeg -version 2>&1 | head -n1 || echo 'Not installed')"
          echo "yt-dlp: $(yt-dlp --version 2>&1 || echo 'Not installed')"
          
          # Install
          echo -e "\n=== Running Installation ==="
          chmod +x install.sh
          ./install.sh
          
          # Refresh
          export PATH="/usr/local/go/bin:$HOME/.local/bin:$PATH"
          echo "/usr/local/go/bin" >> $GITHUB_PATH
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          
          # Verify
          echo -e "\n=== Verification ==="
          go version && echo "âœ“ Go OK" || exit 1
          ffmpeg -version | head -n1 && echo "âœ“ FFmpeg OK" || exit 1
          yt-dlp --version && echo "âœ“ yt-dlp OK" || exit 1
          ls -lah ntgcalls/ *.dylib 2>/dev/null && echo "âœ“ ntgcalls OK"
          
          # Build
          go mod download && go mod verify
          CGO_ENABLED=1 go build  ./cmd/app

  # ========================
  # Test on Windows
  # ========================
  test-windows:
    name: Windows Latest
    runs-on: windows-latest
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸš€ Install & âœ… Verify
        shell: bash
        run: |
          echo "=== Initial State ==="
          echo "OS: $(uname -s)"
          echo "Go: $(go version 2>&1 || echo 'Not installed')"
          echo "Python: $(python --version 2>&1 || echo 'Not installed')"
          
          echo -e "\n=== Running Installation ==="
          chmod +x install.sh
          ./install.sh || echo "Installation completed with warnings (expected on Windows)"
          
          export PATH="/usr/local/go/bin:$HOME/.local/bin:$PATH"
          echo "/usr/local/go/bin" >> $GITHUB_PATH
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          
          echo -e "\n=== Verification ==="
          if command -v go >/dev/null 2>&1; then
            go version && echo "âœ“ Go OK"
          else
            echo "âš  Go not installed (may be expected on Windows)"
          fi
          
          if command -v python >/dev/null 2>&1 || command -v python3 >/dev/null 2>&1; then
            echo "âœ“ Python available"
          fi
          
          # Build test (may fail on Windows, that's ok)
          go mod download 2>/dev/null || true
          go build ./cmd/app  && echo "âœ“ Build successful" || echo "âš  Build skipped on Windows"
       # continue-on-error: true 

  # ========================
  # Test Go Upgrade
  # ========================
  test-go-upgrade:
    name: Go Upgrade (Ubuntu 22.04)
    runs-on: ubuntu-22.04
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ“¦ Install Old Go & ğŸš€ Upgrade & âœ… Verify
        run: |
          # Install old Go
          wget -q https://go.dev/dl/go1.20.linux-amd64.tar.gz
          sudo tar -C /usr/local -xzf go1.20.linux-amd64.tar.gz
          export PATH=/usr/local/go/bin:$PATH
          echo "Old Go: $(go version)"
          
          # Run installer
          chmod +x install.sh
          ./install.sh
          
          export PATH="/usr/local/go/bin:$PATH"
          echo "/usr/local/go/bin" >> $GITHUB_PATH
          
          # Verify upgrade
          GO_VERSION=$(go version | awk '{print $3}' | sed 's/go//')
          echo "New Go: $GO_VERSION"
          
          if [[ "$GO_VERSION" == 1.25.* ]]; then
            echo "âœ“ Go upgraded to 1.25.x"
          else
            echo "âœ— Go not 1.25.x"
            exit 1
          fi
          
          go mod download && go build  ./cmd/app && echo "âœ“ Build successful"

  # ========================
  # Test Minimal System
  # ========================
  test-minimal-system:
    name: Minimal System (Ubuntu 22.04)
    runs-on: ubuntu-22.04
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ§¹ Remove Tools & ğŸš€ Install & âœ… Verify
        run: |
          # Remove tools
          sudo apt-get remove -y golang-go python3-pip ffmpeg || true
          sudo rm -rf /usr/local/go || true
          
          echo "=== Minimal System Verified ==="
          ! command -v go && echo "âœ“ Go removed"
          ! command -v ffmpeg && echo "âœ“ FFmpeg removed"
          ! command -v yt-dlp && echo "âœ“ yt-dlp removed"
          
          # Install everything
          chmod +x install.sh
          ./install.sh
          
          export PATH="/usr/local/go/bin:$HOME/.local/bin:$PATH"
          echo "/usr/local/go/bin" >> $GITHUB_PATH
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          
          # Verify all installed
          echo -e "\n=== Verification ==="
          go version && echo "âœ“ Go" || exit 1
          ffmpeg -version | head -n1 && echo "âœ“ FFmpeg" || exit 1
          yt-dlp --version && echo "âœ“ yt-dlp" || exit 1
          
          go mod download && go build ./cmd/app && echo "âœ“ Build successful"
        env:
          DEBIAN_FRONTEND: noninteractive

  # ========================
  # Test Python 3.12+
  # ========================
  test-python-312:
    name: Python 3.12+ (Ubuntu 24.04)
    runs-on: ubuntu-24.04
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ§¹ Remove yt-dlp & ğŸš€ Install & âœ… Verify
        run: |
          PYTHON_VER=$(python3 --version | awk '{print $2}')
          echo "Python version: $PYTHON_VER"
          
          sudo apt-get remove -y yt-dlp || true
          sudo rm -f /usr/local/bin/yt-dlp || true
          
          chmod +x install.sh
          ./install.sh
          
          export PATH="$HOME/.local/bin:$PATH"
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          
          yt-dlp --version && echo "âœ“ yt-dlp works with Python 3.12+"
          go mod download && go build ./cmd/app && echo "âœ“ Build successful"

  # ========================
  # Integration Test
  # ========================
  integration-test:
    name: Full Integration
    runs-on: ubuntu-22.04
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸš€ Full Install & Build & Test
        run: |
          chmod +x install.sh
          ./install.sh
          
          export PATH="/usr/local/go/bin:$HOME/.local/bin:$PATH"
          echo "/usr/local/go/bin" >> $GITHUB_PATH
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          
          # Full build with optimizations
          go mod download && go mod tidy && go mod verify
          CGO_ENABLED=1 go build -trimpath -ldflags="-w -s" -o myapp ./cmd/app
          
          ls -lh myapp
          file myapp
          
          echo "=== All Dependencies ==="
          go version
          ffmpeg -version | head -n1
          yt-dlp --version
          python3 --version
          echo "âœ“ Integration test passed"

  # ========================
  # Test Idempotency
  # ========================
  test-idempotency:
    name: Idempotency (Run Twice)
    runs-on: ubuntu-22.04
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸš€ Run Twice & Compare
        run: |
          chmod +x install.sh
          
          # First run
          ./install.sh
          export PATH="/usr/local/go/bin:$HOME/.local/bin:$PATH"
          go version > /tmp/first.txt
          ffmpeg -version | head -n1 >> /tmp/first.txt
          yt-dlp --version >> /tmp/first.txt
          
          # Second run
          ./install.sh
          go version > /tmp/second.txt
          ffmpeg -version | head -n1 >> /tmp/second.txt
          yt-dlp --version >> /tmp/second.txt
          
          # Compare
          if diff /tmp/first.txt /tmp/second.txt; then
            echo "âœ“ Script is idempotent"
          else
            echo "âš  Versions changed (may be acceptable)"
          fi
          
          go mod download && go build  ./cmd/app

  # ========================
  # Test Error Recovery
  # ========================
  test-error-recovery:
    name: Error Recovery
    runs-on: ubuntu-22.04
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸš§ Break & Fix & Verify
        run: |
          # Simulate problematic environment
          sudo rm -rf /var/lib/apt/lists/* || true
          
          chmod +x install.sh
          ./install.sh || echo "Script completed with warnings"
          
          export PATH="/usr/local/go/bin:$HOME/.local/bin:$PATH"
          
          # Check what installed despite issues
          if command -v go >/dev/null 2>&1; then
            echo "âœ“ Go survived issues"
            go version
            go mod download || true
            go build ./cmd/app || echo "Build failed (acceptable)"
          else
            echo "âš  Go failed (acceptable in error scenario)"
          fi
        continue-on-error: true

  # ========================
  # Summary
  # ========================
  test-summary:
    name: ğŸ“Š Test Summary
    runs-on: ubuntu-22.04
    needs: [test-ubuntu, test-macos, test-windows, test-go-upgrade, test-minimal-system, test-python-312, integration-test, test-idempotency, test-error-recovery]
    if: always()
    
    steps:
      - name: ğŸ“‹ Results
        run: |
          echo "==================================="
          echo "  Installation Script Test Summary"
          echo "==================================="
          echo ""
          echo "âœ“ Ubuntu:          ${{ needs.test-ubuntu.result }}"
          echo "âœ“ macOS:           ${{ needs.test-macos.result }}"
          echo "âœ“ Windows:         ${{ needs.test-windows.result }}"
          echo "âœ“ Go Upgrade:      ${{ needs.test-go-upgrade.result }}"
          echo "âœ“ Minimal System:  ${{ needs.test-minimal-system.result }}"
          echo "âœ“ Python 3.12+:    ${{ needs.test-python-312.result }}"
          echo "âœ“ Integration:     ${{ needs.integration-test.result }}"
          echo "âœ“ Idempotency:     ${{ needs.test-idempotency.result }}"
          echo "âœ“ Error Recovery:  ${{ needs.test-error-recovery.result }}"
          echo ""
          echo "==================================="
          
          if [[ "${{ needs.test-ubuntu.result }}" == "success" ]] && \
             [[ "${{ needs.test-macos.result }}" == "success" ]] && \
             [[ "${{ needs.test-go-upgrade.result }}" == "success" ]] && \
             [[ "${{ needs.test-minimal-system.result }}" == "success" ]] && \
             [[ "${{ needs.integration-test.result }}" == "success" ]]; then
            echo "ğŸ‰ All critical tests passed!"
            exit 0
          else
            echo "âŒ Some tests failed. Review logs."
            exit 1
          fi
